---
title: 'ã€Dockerã€‘ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™å•é¡Œã‚’è§£æ±ºã—ãŸã„'
date: '2025-08-07'
tags: ['Docker', 'Linux', 'é–‹ç™ºç’°å¢ƒ', 'Dockerfile']
excerpt: 'Dockerã§é »ç™ºã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™å•é¡Œã«ã¤ã„ã¦ã€åŸå› ã‹ã‚‰æ ¹æœ¬çš„ãªè§£æ±ºç­–ã¾ã§è©³ã—ãè§£èª¬ã—ã¾ã™'
---

Dockeré–‹ç™ºã‚’é€²ã‚ã¦ã„ã‚‹ã¨ã“ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®å•é¡Œã«ã‚ˆãé­é‡ã—ã¾ã™ã€‚

```bash
$ git pull
error: unable to unlink old 'app/data.txt': Permission denied
```

```bash
$ npm install
Error: EACCES: permission denied, open 'package.json'
```

ä»Šå›ã¯Dockerå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«åŸºã¥ã„ã¦ã€Dockerã§é »ç¹ã«ç™ºç”Ÿã™ã‚‹ä»£è¡¨çš„ãªå•é¡Œã®ä¸€ã¤ã§ã‚ã‚‹ã“ã®ã‚ˆã†ãªæ¨©é™å•é¡Œã«ã¤ã„ã¦ã€åŸå› ã‹ã‚‰è§£æ±ºç­–ã¾ã§è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## å•é¡Œã®æ ¹æœ¬åŸå› 

### ãªãœã“ã®ã‚ˆã†ãªæ¨©é™å•é¡ŒãŒèµ·ã“ã‚‹ã®ã‹

Docker volumeã§ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ãŒãƒ›ã‚¹ãƒˆã¨ã‚³ãƒ³ãƒ†ãƒŠã§åŒä¸€ã«è¦‹ãˆã¾ã™ãŒã€é‡è¦ãªã®ã¯UIDï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰ã¨GIDï¼ˆã‚°ãƒ«ãƒ¼ãƒ—IDï¼‰ã®ã¿ã§ã™ã€‚

**å•é¡ŒãŒç™ºç”Ÿã™ã‚‹æµã‚Œ**

1. **ã‚³ãƒ³ãƒ†ãƒŠå†…ä½œæ¥­**ï¼šrootï¼ˆUID 0ï¼‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
2. **ãƒ›ã‚¹ãƒˆç’°å¢ƒ**ï¼šä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUID 1000ï¼‰ã§ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
3. **çµæœ**ï¼šæ¨©é™ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ

```bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
docker exec -it myapp touch /app/data/newfile.txt

# ãƒ›ã‚¹ãƒˆã§ç¢ºèª
ls -la app/data/
# -rw-r--r-- 1 root root 0 Dec 15 10:00 newfile.txt
#               â†‘     â†‘
#             UID 0  GID 0

# ãƒ›ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUID 1000ï¼‰ã‹ã‚‰ã¯ç·¨é›†ä¸å¯
```

## å•é¡Œç™ºç”Ÿã®ç¢ºèªã¨è¨ºæ–­

### Step 1: æ¨©é™çŠ¶æ³ã®ç¢ºèª

ã¾ãšã€ç¾åœ¨ã®çŠ¶æ³ã‚’æŠŠæ¡ã—ã¾ã—ã‚‡ã†ã€‚
ãƒ›ã‚¹ãƒˆå´ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€æœ‰è€…ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
# ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç¢ºèª
whoami

id
# å‡ºåŠ›ä¾‹
uid=1000(developer) gid=1000(developer)

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ç¢ºèª
ls -la /path/to/volume/

# å‡ºåŠ›ä¾‹
# æ¨©é™     ãƒªãƒ³ã‚¯ æ‰€æœ‰è€…  ã‚°ãƒ«ãƒ¼ãƒ—  ã‚µã‚¤ã‚º    æ—¥æ™‚     ãƒ•ã‚¡ã‚¤ãƒ«å
# drwxr-xr-x 2 root      root      4096 Dec 15 10:07 app_data
# -rw-r--r-- 1 root      root       256 Dec 15 10:07 config.json
```

ä¸Šè¨˜ã®å‡ºåŠ›ä¾‹ã‚’è¦‹ã‚‹ã¨ã€ç¾åœ¨ã®ãƒ›ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã¯1000ã§ã™ãŒã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€æœ‰è€…ã¯ã€Œroot rootã€ï¼ˆUID 0ã€GID 0ï¼‰ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã“ã“ã§é‡è¦ãªã®ã¯ã€ãƒ›ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDï¼ˆ1000ï¼‰ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰€æœ‰è€…ï¼ˆroot/UID 0ï¼‰ãŒç•°ãªã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ä¸ä¸€è‡´ãŒæ¨©é™å•é¡Œã®åŸå› ã¨ãªã‚Šã¾ã™ã€‚

### Step 2: ã‚³ãƒ³ãƒ†ãƒŠå†…ã®çŠ¶æ³ç¢ºèª

æ¬¡ã«ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
docker exec -it container_name id

# å‡ºåŠ›ä¾‹
uid=0(root) gid=0(root)

# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
docker exec -it container_name ls -la /app/data/
```

ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã¯rootï¼ˆUID 0ï¼‰ã§å‹•ä½œã—ã¦ã„ã‚‹ãŸã‚ã€ä½œæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚rootæ‰€æœ‰ã«ãªã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã“ã®é•ã„ãŒæ¨©é™å•é¡Œã®åŸå› ã§ã™ã€‚

## å¿œæ€¥å‡¦ç½®çš„ãªè§£æ±ºç­–

### æ¨©é™ã®ä¿®æ­£

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®è§£æ±ºæ–¹æ³•ã§ã™ã€‚

```bash
# ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ä¾‹
error: unable to unlink old 'file.txt': Permission denied
Error: EACCES: permission denied, open 'package.json'
rm: cannot remove 'app.log': Permission denied
```

> **Note**
> **å®‰å…¨æ€§ã«ã¤ã„ã¦**ï¼šã“ã®æ“ä½œã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ãƒ•ã‚¡ã‚¤ãƒ«æ‰€æœ‰è€…ã®ã¿ã‚’å¤‰æ›´ã—ã€ä»–ã®é–‹ç™ºãƒ¡ãƒ³ãƒãƒ¼ã‚„Gitãƒªãƒã‚¸ãƒˆãƒªã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚Gitã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã®ã¿ã‚’ç®¡ç†ã—ã€æ‰€æœ‰è€…æƒ…å ±ï¼ˆUID/GIDï¼‰ã¯è¿½è·¡ã—ãªã„ãŸã‚ã§ã™ã€‚

```bash
# æ‰€æœ‰è€…ã‚’ãƒ›ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´
sudo chown -R "$(whoami)":"$(whoami)" /path/to/volume/

# ç¢ºèª
ls -la /path/to/volume/

# å‡ºåŠ›ä¾‹
# æ¨©é™     ãƒªãƒ³ã‚¯ æ‰€æœ‰è€…   ã‚°ãƒ«ãƒ¼ãƒ—  ã‚µã‚¤ã‚º   ã€€æ—¥æ™‚     ãƒ•ã‚¡ã‚¤ãƒ«å 
# drwxr-xr-x 2 developer developer 4096 Dec 15 10:07 app_data
# -rw-r--r-- 1 developer developer  256 Dec 15 10:07 config.json
```

## æ ¹æœ¬çš„ãªè§£æ±ºç­–

### 1. érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰

Dockerå…¬å¼ã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãŒç‰¹æ¨©ãªã—ã§å‹•ä½œå¯èƒ½ãªå ´åˆã€USERã‚’ä½¿ç”¨ã—ã¦érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚ã»ã¨ã‚“ã©ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯rootæ¨©é™ã‚’å¿…è¦ã¨ã—ãªã„ãŸã‚ã€érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã§ãã¾ã™ã€‚

**Dockerfileè¨­è¨ˆ**

```dockerfile
FROM node:18-alpine

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# ãƒ•ã‚¡ã‚¤ãƒ«æ‰€æœ‰è€…ã‚’å¤‰æ›´
COPY --chown=appuser:appgroup . .

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
USER appuser

CMD ["npm", "start"]
```

### 2. å‹•çš„UID/GIDè¨­å®š

ã“ã‚ŒãŒç¾å ´ã§æœ€ã‚‚å®Ÿç”¨çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚
ãƒ›ã‚¹ãƒˆã®UID/GIDã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å–å¾—ã—ã€docker-composeçµŒç”±ã§ã‚³ãƒ³ãƒ†ãƒŠã«æ¸¡ã—ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€é–‹ç™ºè€…ã”ã¨ã«ç•°ãªã‚‹UID/GIDã§ã‚‚è‡ªå‹•çš„ã«å¯¾å¿œã§ãã€ãƒãƒ¼ãƒ é–‹ç™ºã§ã®æ¨©é™å•é¡Œã‚’é˜²ã’ã¾ã™ã€‚

ã¾ãšã€docker-compose.ymlã§UID/GIDã‚’å‹•çš„ã«è¨­å®šã—ã¾ã™ã€‚

**docker-compose.yml**

```yaml
version: '3.8'
services:
  app:
    build:
      context: .
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - ./app:/app
    environment:
      - NODE_ENV=development
```

**Dockerfileï¼ˆARGå¯¾å¿œç‰ˆï¼‰**

æ¬¡ã«ã€ARGã§UID/GIDã‚’å—ã‘å–ã‚‹Dockerfileã‚’ä½œæˆã—ã¾ã™ã€‚

```dockerfile
FROM node:18-alpine

# ãƒ“ãƒ«ãƒ‰å¼•æ•°ã§UID/GIDã‚’å—ã‘å–ã‚Š
ARG UID=1000
ARG GID=1000

# å‹•çš„ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN addgroup -g ${GID} appgroup && \
    adduser -u ${UID} -G appgroup -s /bin/sh -D appuser

WORKDIR /app
COPY --chown=appuser:appgroup package*.json ./
RUN npm ci

USER appuser
CMD ["npm", "start"]
```

**ç’°å¢ƒè¨­å®šï¼ˆ.envï¼‰**

UID/GIDã‚’å›ºå®šå€¤ã§è¨­å®šã™ã‚‹å ´åˆã¯ã€.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
# ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UID/GIDã‚’è¨­å®š
UID=1000
GID=1000
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰**

ãã—ã¦ã€å®Ÿéš›ã®å®Ÿè¡Œæ–¹æ³•ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```bash
# ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼UID/GIDã§å®Ÿè¡Œ
UID=$(id -u) GID=$(id -g) docker-compose up

# ã¾ãŸã¯.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
echo "UID=$(id -u)" > .env
echo "GID=$(id -g)" >> .env
docker-compose up
```

### 3. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹å‹•çš„èª¿æ•´

Dockerå…¬å¼ã‚¤ãƒ¡ãƒ¼ã‚¸ã§å®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã€ã‚ˆã‚ŠæŸ”è»Ÿãªæ¨©é™ç®¡ç†ãŒå¯èƒ½ã§ã™ã€‚
ã“ã®æ–¹æ³•ã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦UID/GIDã‚’å‹•çš„ã«å¤‰æ›´ã—ã€æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚‚èª¿æ•´ã—ã¾ã™ã€‚æœ€ã‚‚é«˜åº¦ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ãŒã€è¤‡é›‘ãªæ¨©é™è¦ä»¶ãŒã‚ã‚‹å ´åˆã«æœ‰åŠ¹ã§ã™ã€‚

ã¾ãšã€æ¨©é™èª¿æ•´ã‚’è¡Œã†ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

**entrypoint.sh**

```bash
#!/bin/bash
set -e

# å®Ÿè¡Œæ™‚ã«UID/GIDã‚’èª¿æ•´
if [ -n "$LOCAL_UID" ]; then
    usermod -u "$LOCAL_UID" appuser
fi

if [ -n "$LOCAL_GID" ]; then
    groupmod -g "$LOCAL_GID" appgroup
fi

# ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®æ¨©é™ã‚’èª¿æ•´
chown -R appuser:appgroup /app/data

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
exec gosu appuser "$@"
```

**Dockerfile**

```dockerfile
FROM node:18-alpine

# shadowãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆusermod/groupmodä½¿ç”¨ã®ãŸã‚ï¼‰
RUN apk add --no-cache gosu shadow

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /app
COPY --chown=appuser:appgroup . .

ENTRYPOINT ["/entrypoint.sh"]
CMD ["npm", "start"]
```

**å®Ÿè¡Œ**

```bash
docker run -e LOCAL_UID=$(id -u) -e LOCAL_GID=$(id -g) myapp
```

## é–‹ç™ºãƒãƒ¼ãƒ å‘ã‘ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ãƒãƒ¼ãƒ çµ±ä¸€è¨­å®š

ãƒãƒ¼ãƒ å…¨ä½“ã§çµ±ä¸€ã—ãŸDockerç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã€å…±é€šè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
docker-compose.override.ymlã¯è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ãŸã‚ã€é–‹ç™ºè€…ã”ã¨ã®å€‹åˆ¥è¨­å®šãŒå¯èƒ½ã§ã™ã€‚

**é–‹ç™ºç’°å¢ƒç”¨docker-compose.override.yml**

```yaml
version: '3.8'
services:
  app:
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      - .:/app
      - node_modules:/app/node_modules  # ä¾å­˜é–¢ä¿‚ã¯åˆ†é›¢
```

### 2. æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

æ¨©é™å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹ã‚’ç°¡å˜ã«ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚
ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å•é¡Œã‚’ç™ºè¦‹ã—ãŸå ´åˆã€ä¿®æ­£ã‚³ãƒãƒ³ãƒ‰ã‚‚æç¤ºã—ã¦ãã‚Œã¾ã™ã€‚

**check-permissions.sh**

```bash
#!/bin/bash
echo "=== Dockeræ¨©é™ãƒã‚§ãƒƒã‚¯ ==="

# ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
echo "ãƒ›ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼: $(whoami) (UID: $(id -u), GID: $(id -g))"

# å•é¡Œã®ã‚ã‚‹rootæ‰€æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
ROOT_FILES=$(find . -user root -type f 2>/dev/null | head -5)
if [ -n "$ROOT_FILES" ]; then
    echo "âš ï¸  rootæ‰€æœ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼š"
    echo "$ROOT_FILES"
    echo ""
    echo "ä¿®æ­£ã‚³ãƒãƒ³ãƒ‰ï¼š"
    echo "sudo chown -R \$(whoami):\$(whoami) ."
else
    echo "âœ… æ¨©é™å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
fi
```

### 3. Makefileçµ±åˆ

ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰ã‚’Makefileã«ã¾ã¨ã‚ã‚‹ã“ã¨ã§ã€ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ãŒç°¡å˜ã«Dockerç’°å¢ƒã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```makefile
.PHONY: setup check-permissions fix-permissions

setup:
	@echo "UID=$(shell id -u)" > .env
	@echo "GID=$(shell id -g)" >> .env
	@echo "ç’°å¢ƒè¨­å®šå®Œäº†"

check-permissions:
	@./scripts/check-permissions.sh

fix-permissions:
	sudo chown -R "$(shell whoami)":"$(shell whoami)" .
	@echo "æ¨©é™ä¿®æ­£å®Œäº†"

dev: setup
	UID=$(shell id -u) GID=$(shell id -g) docker-compose up
```

ä½¿ã„æ–¹ğŸ‘‡
```bash
# ç’°å¢ƒè¨­å®š
make setup
# æ¨©é™ãƒã‚§ãƒƒã‚¯  
make check-permissions
# æ¨©é™ä¿®æ­£
make fix-permissions
# é–‹ç™ºç’°å¢ƒèµ·å‹•
make dev
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. æœ€å°æ¨©é™ã®åŸå‰‡

ã‚³ãƒ³ãƒ†ãƒŠã‚’non-rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€containerâ†’hostç‰¹æ¨©æ˜‡æ ¼ã®ãƒªã‚¹ã‚¯ã‚’å¤§å¹…ã«è»½æ¸›ã§ãã¾ã™ã€‚

```dockerfile
# rootã§å®Ÿè¡Œã€æ¨©é™ãŒç·©ã™ãã‚‹ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰
USER root                # rootã§å®Ÿè¡Œï¼ˆå±é™ºï¼‰
RUN chmod 777 /app/data  # å…¨å“¡ãŒãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´å¯èƒ½ï¼ˆå±é™ºï¼‰

# ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œã€æœ€å°æ¨©é™ï¼ˆãŠã™ã™ã‚ï¼‰
USER appuser             # ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œï¼ˆå®‰å…¨ï¼‰
RUN chmod 755 /app/data  # å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ï¼ˆå®‰å…¨ï¼‰
```

rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®å®Ÿè¡Œã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãŒä¾µå®³ã•ã‚ŒãŸéš›ã«ãƒ›ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¸ã®å½±éŸ¿ãŒå¤§ãããªã‚Šã¾ã™ã€‚
ã¾ãŸã€777ã®æ¨©é™è¨­å®šã¯èª°ã§ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã§ãã‚‹ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒé«˜ã¾ã‚Šã¾ã™ã€‚

### 2. UIDç¯„å›²ã®è€ƒæ…®

UID 10000æœªæº€ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã¨ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€æœ¬ç•ªç’°å¢ƒã§ã¯é«˜ã„UIDå€¤ã‚’ä½¿ç”¨ã™ã‚‹ã¨å®‰å…¨ã§ã™ã€‚ä½ã„UIDå€¤ã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨é‡è¤‡ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€æ„å›³ã—ãªã„ç®¡ç†è€…æ¨©é™ã‚’æŒã£ã¦ã—ã¾ã†å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

```dockerfile
# æœ¬ç•ªç’°å¢ƒæ¨å¥¨è¨­å®š
ARG UID=10000
ARG GID=10001
```

### 3. gosuä½¿ç”¨æ™‚ã®æ³¨æ„ç‚¹

gosuã¯ä¸»ã«ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•æ™‚ï¼ˆENTRYPOINTã§ã®ä½¿ç”¨ï¼‰ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒ†ãƒŠã®åˆæœŸåŒ–å‡¦ç†ã§rootã‹ã‚‰ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ¨©é™ã‚’ä¸‹ã’ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹ã®ãŒæœ¬æ¥ã®ç›®çš„ã§ã™ã€‚ãã‚Œä»¥å¤–ã®ç”¨é€”ã§ã®ä½¿ç”¨ã¯ã€æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚é©åˆ‡ãªã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒä»¥å¤–ã§ã®ä½¿ç”¨ã¯é¿ã‘ã‚‹ã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

> **Note**
> gosuã¨ã¯
> gosuã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚sudoã«ä¼¼ã¦ã„ã¾ã™ãŒã€ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã«ç‰¹åŒ–ã—ã¦è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢ã‚„å†èµ·å‹•ãŒã‚ˆã‚Šæ­£å¸¸ã«å‹•ä½œã—ã¾ã™ã€‚

## äºˆé˜²ç­–ã¨ãƒãƒ¼ãƒ é‹ç”¨

### 1. é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ±åˆ

Git pullã®å¾Œã«æ¨©é™å•é¡Œã‚’è‡ªå‹•æ¤œå‡ºã™ã‚‹ãƒ•ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¨­å®šã§ãã¾ã™ã€‚

**Git hooksè¨­å®šï¼ˆ.git/hooks/post-mergeï¼‰**

```bash
#!/bin/bash
# pullå¾Œã®æ¨©é™ãƒã‚§ãƒƒã‚¯
if [ -d "app_data" ] && [ "$(stat -c %U app_data)" = "root" ]; then
    echo "âš ï¸  æ¨©é™å•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
    echo "å®Ÿè¡Œã—ã¦ãã ã•ã„: sudo chown -R \$(whoami):\$(whoami) app_data"
fi
```

ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆå¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

```bash
chmod +x .git/hooks/post-merge
```

### 2. CI/CDè¨­å®š

CI/CDç’°å¢ƒã§ã‚‚æ¨©é™å•é¡Œã‚’é˜²ããŸã‚ã®è¨­å®šä¾‹ã§ã™ã€‚

**GitHub Actionsä¾‹**

```yaml
name: Docker Build Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up environment
        run: |
          echo "UID=$(id -u)" >> .env
          echo "GID=$(id -g)" >> .env
          
      - name: Build and test
        run: |
          UID=$(id -u) GID=$(id -g) docker-compose build
          UID=$(id -u) GID=$(id -g) docker-compose run --rm app npm test
          
      - name: Check permissions
        run: |
          # æ¨©é™å•é¡ŒãŒãªã„ã“ã¨ã‚’ç¢ºèª
          find . -user root -type f | grep -v ".git" && exit 1 || true
```

## ã¾ã¨ã‚

Dockerç’°å¢ƒã§ã®æ¨©é™å•é¡Œã¯ã€å¤šãã®æ–¹ã€…ãŒçµŒé¨“ã™ã‚‹æ‚©ã¿ã®ä¸€ã¤ã ã¨æ€ã„ã¾ã™ã€‚
ã—ã‹ã—é©åˆ‡ã«ç†è§£ã—ã¦å¯¾ç­–ã‚’ã™ã‚Œã°ã€è§£æ±ºãƒ»äºˆé˜²ã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ã€‚

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¾ã¨ã‚

1. **ä¸€æ™‚çš„ãªè§£æ±º**: `sudo chown -R "$(whoami)":"$(whoami)"` ã§æ¨©é™ä¿®æ­£
2. **ç’°å¢ƒå¤‰æ•°ã§ã®å¯¾å¿œ**: `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã§UID/GIDè¨­å®š
3. **æ ¹æœ¬çš„ãªè§£æ±º**: érootãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡Œ + å‹•çš„UID/GIDè¨­å®š
4. **ãƒãƒ¼ãƒ å…¨ä½“**: çµ±ä¸€ã•ã‚ŒãŸé–‹ç™ºç’°å¢ƒè¨­å®š

### ãƒã‚¤ãƒ³ãƒˆ

- UID/GIDã®ã¿ãŒæ¨©é™æ±ºå®šã«é‡è¦
- érootãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿè¡ŒãŒå…¬å¼æ¨å¥¨
- ãƒ­ãƒ¼ã‚«ãƒ«ã®æ¨©é™ä¿®æ­£ã¯ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã«å½±éŸ¿ã—ãªã„
- äºˆé˜²ç­–ã®å°å…¥ã§ãƒãƒ¼ãƒ å…¨ä½“ã®é–‹ç™ºåŠ¹ç‡å‘ä¸Š

ã“ã®è¨˜äº‹ãŒåŒã˜ã‚ˆã†ãªå•é¡Œã«æ‚©ã‚€æ–¹ã€…ã®ãƒ’ãƒ³ãƒˆã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
çš†ã•ã‚“ã®Dockeré–‹ç™ºãŒã‚ˆã‚Šå®‰å…¨ã§ãŸã®ã—ãåŠ¹ç‡çš„ã«ãªã‚‹ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ğŸ³

---

## å‚è€ƒã‚µã‚¤ãƒˆ

- [Dockerå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - Volumes](https://docs.docker.com/engine/storage/volumes/)
- [Dockerå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - Best practices](https://docs.docker.com/build/building/best-practices/)
- [Dockerå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ - Security](https://docs.docker.com/engine/security/)
- [Dockerfile best practices](https://github.com/dnaprawa/dockerfile-best-practices)
- [gosu GitHub Repository](https://github.com/tianon/gosu)